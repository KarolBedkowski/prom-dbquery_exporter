# dbquery_exporter v0.7.x

The dbquery_exporter allow to scrap metrics from supported SQL databases by user-defined SQL-s
and templates.

Support: SQLite, PostgrSQL, Oracle, MySQL/MariaDB/TiDB, MSSQL (not tested).


## Building and running

### Dependency

* golang 1.17
* see: go.mod

#### Database drivers
* PostgrSQL: github.com/lib/pq
* SQLite: github.com/mattn/go-sqlite3
* Oracle: github.com/mattn/go-oci8 - require enable on compile and external libraries
* MSSQL: github.com/denisenkom/go-mssqldb - require enable on compile
* MySQL/MariaDB/TiB: github.com/go-sql-driver/mysql - require enable on compile


### Local Build & Run

    make build
    ./dbquery_exporter

For help:

    ./dbquery_exporter -help

Edit `dbquery.yaml` file, run and visit `http://localhost:9122/query?query=<query_name>&database=<database_name>`.
See dbquery.yaml for configuration examples.

## Prometheus config

    scrape_configs:

        [...]

     # query one query on many databases
     - job_name: dbquery_scrape
       static_configs:
       - targets:
           - testq1  # query name
       params:
         database: [testdb]  # databases list
         other_query_param: [100]  # additional query params
       metrics_path: /query
       relabel_configs:
       - source_labels: [__address__]
           target_label: __param_query
       - source_labels: [__param_query]
           target_label: query
       - target_label: __address__
           replacement: 127.0.0.1:9122       # dbquery_exporter address

     # query many queries on one database
     - job_name: dbquery_scrape_db
       static_configs:
         - targets:
             - testdbpgsql  # database names
       metrics_path: /query
       params:
         query: [pg_stats_activity_state, pg_stat_database]  # launch many queries
       relabel_configs:
         - source_labels: [__address__]
           target_label: __param_database
         - source_labels: [__param_database]
           target_label: database
         - target_label: __address__
           replacement: 127.0.0.1:9122

     - job_name: dbquery_exporter
         static_configs:
         - targets:
                - 127.0.0.1:9122       # dbquery_exporter address


## Templates

Templates use standard golang text/template format (see: `https://pkg.go.dev/text/template`).

Template should generate real, correct text-formatted Prometheus metrics. Result is
not validate by dbquery_exporter.


### Template context

Data available in tempaltes:

* `.R` - list of records generated by executing query; each record is map
  column name -> value;
* `.Query` - query name (from request/config)
* `.Database` - database name (from request/config)
* `.P` - additional request parameters
* `.L` - labels defined for database
* `.Count` - total number of query result
* `.QueryDuration` - query duration in sec
* `.QueryStartTime` - start query as UNIX time (time of real execution; caching not
  change it)


### Template functions

* toLower - convert value to lower case
* toUpper - convert value to upper case
* trim - trim non-printable characters
* quote - quote " characters
* replaceSpaces - replace spaces by "_"
* removeSpaces - remove spaces
* keepAlfaNum - keep only A-Za-z0-9 characters
* keepAlfaNumUnderline - keep only A-Za-z0-9 and "_" characters
* keepAlfaNumUnderlineSpace - keep only A-Za-z0-9, "_" and space characters
* keepAlfaNumUnderlineU - keep only unicode letter, digits and "_"
* keepAlfaNumUnderlineSpaceU - keep only unicode letter, digits, space and "_"
* clean - keep only A-Za-z0-9 and "_", replace spaces to "_", trim, convert to lower case

### Note

Oracle return column in upper case. Probably NLS_LANG environment variable should be also used in most cases (i.e. `NLS_LANG=American_America.UTF8`).



# License
Copyright (c) 2017-2021, Karol BÄ™dkowski.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
